<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        #game-container {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <script>
        // ============= ÉTAT GLOBAL DU JEU =============
        const gameState = {
            hasStarter: false,
            pokemon: [],
            currentMap: 'outside'
        };

        // ============= SCÈNE UI (INVENTAIRE) =============
        class UIScene extends Phaser.Scene {
            constructor() {
                super('UIScene');
            }
            
            create() {
                const overlay = this.add.rectangle(400, 300, 800, 600, 0x000000, 0.9);
                
                const title = this.add.text(400, 50, 'TON ÉQUIPE POKÉMON', {
                    fontSize: '28px',
                    fill: '#ffcc00',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                
                gameState.pokemon.forEach((pokemon, index) => {
                    const y = 150 + (index * 120);
                    
                    const box = this.add.rectangle(400, y, 700, 100, 0x333333);
                    box.setStrokeStyle(3, 0xffcc00);
                    
                    const sprite = this.add.image(150, y, pokemon.sprite);
                    sprite.setScale(1.5);
                    
                    const nameText = this.add.text(250, y - 30, pokemon.name, {
                        fontSize: '24px',
                        fill: '#fff',
                        fontStyle: 'bold'
                    });
                    
                    const levelText = this.add.text(250, y, `Niveau ${pokemon.level}`, {
                        fontSize: '18px',
                        fill: '#aaa'
                    });
                    
                    const hpBarBg = this.add.rectangle(450, y + 20, 200, 20, 0x555555);
                    const hpPercent = pokemon.hp / pokemon.maxHp;
                    const hpBar = this.add.rectangle(450 - (200 * (1 - hpPercent) / 2), y + 20, 200 * hpPercent, 20, 0x00ff00);
                    
                    const hpText = this.add.text(250, y + 20, `PV: ${pokemon.hp}/${pokemon.maxHp}`, {
                        fontSize: '16px',
                        fill: '#fff'
                    });
                });
                
                const closeButton = this.add.text(400, 550, '[ FERMER (I) ]', {
                    fontSize: '20px',
                    fill: '#fff',
                    backgroundColor: '#ff0000',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5);
                closeButton.setInteractive();
                
                closeButton.on('pointerdown', () => {
                    this.scene.stop();
                    this.scene.resume('GameScene');
                });
                
                closeButton.on('pointerover', () => {
                    closeButton.setStyle({ fill: '#ffff00' });
                });
                
                closeButton.on('pointerout', () => {
                    closeButton.setStyle({ fill: '#fff' });
                });
                
                this.input.keyboard.on('keydown-I', () => {
                    this.scene.stop();
                    this.scene.resume('GameScene');
                });
            }
        }

        // ============= SCÈNE PRINCIPALE DU JEU =============
        class GameScene extends Phaser.Scene {
            constructor() {
                super('GameScene');
            }
            
            preload() {
                // Crée des assets de base (placeholder)
                this.createPlaceholderAssets();
            }
            
            createPlaceholderAssets() {
                // Crée un sprite de joueur
                const playerGraphics = this.make.graphics({x: 0, y: 0, add: false});
                
                // 16 frames (4 directions x 4 frames d'animation)
                for (let i = 0; i < 16; i++) {
                    playerGraphics.clear();
                    const color = i % 4 === 0 ? 0x3498db : 0x2980b9;
                    playerGraphics.fillStyle(color);
                    playerGraphics.fillCircle(16, 16, 12);
                    playerGraphics.fillStyle(0x000000);
                    playerGraphics.fillCircle(16, 14, 3);
                    playerGraphics.fillCircle(16, 14, 2);
                    playerGraphics.generateTexture('player-frame-' + i, 32, 32);
                }
                
                // Combine en spritesheet
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 128;
                const ctx = canvas.getContext('2d');
                
                for (let i = 0; i < 16; i++) {
                    const x = (i % 4) * 32;
                    const y = Math.floor(i / 4) * 32;
                    const texture = this.textures.get('player-frame-' + i).getSourceImage();
                    ctx.drawImage(texture, x, y);
                }
                
                this.textures.addCanvas('player', canvas);
                
                // Sol
                const groundGraphics = this.make.graphics({x: 0, y: 0, add: false});
                groundGraphics.fillStyle(0x27ae60);
                groundGraphics.fillRect(0, 0, 32, 32);
                groundGraphics.generateTexture('ground', 32, 32);
                
                // Maison extérieur
                const houseGraphics = this.make.graphics({x: 0, y: 0, add: false});
                houseGraphics.fillStyle(0x8b4513);
                houseGraphics.fillRect(0, 0, 120, 100);
                houseGraphics.fillStyle(0xe74c3c);
                houseGraphics.fillTriangle(60, 0, 0, 30, 120, 30);
                houseGraphics.fillStyle(0x654321);
                houseGraphics.fillRect(45, 60, 30, 40);
                houseGraphics.generateTexture('house-exterior', 120, 100);
                
                // Intérieur maison
                const interiorGraphics = this.make.graphics({x: 0, y: 0, add: false});
                interiorGraphics.fillStyle(0xd4a574);
                interiorGraphics.fillRect(0, 0, 800, 600);
                interiorGraphics.fillStyle(0x8b6f47);
                for (let i = 0; i < 800; i += 40) {
                    for (let j = 0; j < 600; j += 40) {
                        interiorGraphics.strokeRect(i, j, 40, 40);
                    }
                }
                interiorGraphics.generateTexture('house-interior', 800, 600);
                
                // Table avec Pokéballs
                const table1Graphics = this.make.graphics({x: 0, y: 0, add: false});
                table1Graphics.fillStyle(0x8b4513);
                table1Graphics.fillRect(0, 0, 100, 60);
                table1Graphics.fillStyle(0xff0000);
                table1Graphics.fillCircle(30, 30, 10);
                table1Graphics.fillCircle(50, 30, 10);
                table1Graphics.fillCircle(70, 30, 10);
                table1Graphics.fillStyle(0xffffff);
                table1Graphics.fillCircle(30, 30, 5);
                table1Graphics.fillCircle(50, 30, 5);
                table1Graphics.fillCircle(70, 30, 5);
                table1Graphics.generateTexture('table-pokeballs', 100, 60);
                
                // Table vide
                const table2Graphics = this.make.graphics({x: 0, y: 0, add: false});
                table2Graphics.fillStyle(0x8b4513);
                table2Graphics.fillRect(0, 0, 100, 60);
                table2Graphics.generateTexture('table-empty', 100, 60);
                
                // Pokémon sprites
                const bulbizarreGraphics = this.make.graphics({x: 0, y: 0, add: false});
                bulbizarreGraphics.fillStyle(0x78c850);
                bulbizarreGraphics.fillCircle(32, 32, 25);
                bulbizarreGraphics.fillStyle(0x2ecc71);
                bulbizarreGraphics.fillCircle(32, 20, 15);
                bulbizarreGraphics.generateTexture('bulbizarre', 64, 64);
                
                const salamecheGraphics = this.make.graphics({x: 0, y: 0, add: false});
                salamecheGraphics.fillStyle(0xf08030);
                salamecheGraphics.fillCircle(32, 32, 25);
                salamecheGraphics.fillStyle(0xffa500);
                salamecheGraphics.fillCircle(32, 20, 10);
                salamecheGraphics.generateTexture('salameche', 64, 64);
                
                const carapuceGraphics = this.make.graphics({x: 0, y: 0, add: false});
                carapuceGraphics.fillStyle(0x6890f0);
                carapuceGraphics.fillCircle(32, 32, 25);
                carapuceGraphics.fillStyle(0x3498db);
                carapuceGraphics.fillCircle(32, 40, 20);
                carapuceGraphics.generateTexture('carapuce', 64, 64);
            }
            
            create() {
                this.createPlayerAnimations();
                this.createOutsideMap();
                
                this.player = this.physics.add.sprite(400, 300, 'player');
                this.player.setCollideWorldBounds(true);
                this.speed = 160;
                
                this.cursors = this.input.keyboard.createCursorKeys();
                this.interactKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E);
                this.inventoryKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.I);
                
                this.cameras.main.startFollow(this.player);
                
                this.helpText = this.add.text(10, 10, 'Flèches: Bouger | E: Interagir | I: Inventaire', {
                    fontSize: '14px',
                    fill: '#fff',
                    backgroundColor: '#000',
                    padding: { x: 5, y: 5 }
                });
                this.helpText.setScrollFactor(0);
                this.helpText.setDepth(1000);
            }
            
                createPlayerAnimations() {
                this.anims.create({
                    key: 'walk-down',
                    frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
                    frameRate: 8,
                    repeat: -1
                });
                
                this.anims.create({
                    key: 'walk-up',
                    frames: this.anims.generateFrameNumbers('player', { start: 4, end: 7 }),
                    frameRate: 8,
                    repeat: -1
                });
                
                this.anims.create({
                    key: 'walk-left',
                    frames: this.anims.generateFrameNumbers('player', { start: 8, end: 11 }),
                    frameRate: 8,
                    repeat: -1
                });
                
                this.anims.create({
                    key: 'walk-right',
                    frames: this.anims.generateFrameNumbers('player', { start: 12, end: 15 }),
                    frameRate: 8,
                    repeat: -1
                });
                
                this.anims.create({
                    key: 'idle',
                    frames: [{ key: 'player', frame: 0 }],
                    frameRate: 1
                });
            }
            
            createOutsideMap() {
                if (this.currentMap) {
                    this.currentMap.destroy();
                }
                if (this.house) {
                    this.house.destroy();
                }
                if (this.doorZone) {
                    this.doorZone.destroy();
                }
                
                gameState.currentMap = 'outside';
                
                this.currentMap = this.add.group();
                for (let y = 0; y < 20; y++) {
                    for (let x = 0; x < 25; x++) {
                        const tile = this.add.image(x * 32, y * 32, 'ground').setOrigin(0);
                        this.currentMap.add(tile);
                    }
                }
                
                this.house = this.add.image(400, 200, 'house-exterior');
                
                this.doorZone = this.add.rectangle(400, 250, 60, 20, 0xff0000, 0);
                this.physics.add.existing(this.doorZone);
                
                this.physics.world.setBounds(0, 0, 800, 640);
                
                this.helpText.setText('Approche-toi de la porte et appuie sur E');
            }
            
            createInsideMap() {
                if (this.currentMap) {
                    this.currentMap.destroy();
                }
                if (this.house) {
                    this.house.destroy();
                }
                if (this.doorZone) {
                    this.doorZone.destroy();
                }
                
                gameState.currentMap = 'inside';
                
                this.currentMap = this.add.group();
                const interior = this.add.image(400, 300, 'house-interior');
                this.currentMap.add(interior);
                
                const tableImage = gameState.hasStarter ? 'table-empty' : 'table-pokeballs';
                this.table = this.add.image(400, 250, tableImage);
                this.table.setInteractive();
                
                if (!gameState.hasStarter) {
                    this.table.on('pointerdown', () => this.showStarterChoice());
                    
                    this.table.on('pointerover', () => {
                        this.table.setTint(0xffff00);
                    });
                    
                    this.table.on('pointerout', () => {
                        this.table.clearTint();
                    });
                }
                
                this.exitZone = this.add.rectangle(400, 550, 60, 20, 0x00ff00, 0);
                this.physics.add.existing(this.exitZone);
                
                this.physics.world.setBounds(0, 0, 800, 600);
                
                this.helpText.setText('Clique sur la table ! | Sors par le bas (E)');
            }
            
            showStarterChoice() {
                this.physics.pause();
                
                const overlay = this.add.rectangle(400, 300, 800, 600, 0x000000, 0.8);
                overlay.setDepth(100);
                
                const title = this.add.text(400, 100, 'Choisis ton Pokémon !', {
                    fontSize: '32px',
                    fill: '#ffcc00',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                title.setDepth(101);
                
                const starters = [
                    { name: 'Bulbizarre', key: 'bulbizarre', x: 200 },
                    { name: 'Salamèche', key: 'salameche', x: 400 },
                    { name: 'Carapuce', key: 'carapuce', x: 600 }
                ];
                
                const choices = [];
                
                starters.forEach(starter => {
                    const sprite = this.add.image(starter.x, 280, starter.key);
                    sprite.setScale(2);
                    sprite.setDepth(101);
                    sprite.setInteractive();
                    
                    const nameText = this.add.text(starter.x, 380, starter.name, {
                        fontSize: '22px',
                        fill: '#fff',
                        fontStyle: 'bold'
                    }).setOrigin(0.5);
                    nameText.setDepth(101);
                    
                    const chooseButton = this.add.text(starter.x, 420, 'CHOISIR', {
                        fontSize: '18px',
                        fill: '#fff',
                        backgroundColor: '#27ae60',
                        padding: { x: 15, y: 8 }
                    }).setOrigin(0.5);
                    chooseButton.setDepth(101);
                    chooseButton.setInteractive();
                    
                    sprite.on('pointerover', () => {
                        sprite.setTint(0xffff00);
                    });
                    
                    sprite.on('pointerout', () => {
                        sprite.clearTint();
                    });
                    
                    chooseButton.on('pointerover', () => {
                        chooseButton.setStyle({ fill: '#ffff00' });
                        sprite.setTint(0xffff00);
                    });
                    
                    chooseButton.on('pointerout', () => {
                        chooseButton.setStyle({ fill: '#fff' });
                        sprite.clearTint();
                    });
                    
                    const selectStarter = () => {
                        this.chooseStarter(starter.name, starter.key);
                        overlay.destroy();
                        title.destroy();
                        choices.forEach(c => {
                            c.sprite.destroy();
                            c.text.destroy();
                            c.button.destroy();
                        });
                    };
                    
                    sprite.on('pointerdown', selectStarter);
                    chooseButton.on('pointerdown', selectStarter);
                    
                    choices.push({ sprite, text: nameText, button: chooseButton });
                });
            }
            
            chooseStarter(name, key) {
                gameState.pokemon.push({
                    name: name,
                    sprite: key,
                    level: 5,
                    hp: 20,
                    maxHp: 20
                });
                
                gameState.hasStarter = true;
                
                this.table.setTexture('table-empty');
                this.table.removeInteractive();
                
                const confirmText = this.add.text(400, 300, `Tu as choisi ${name} !`, {
                    fontSize: '28px',
                    fill: '#ffcc00',
                    backgroundColor: '#000',
                    padding: { x: 20, y: 15 },
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                confirmText.setDepth(200);
                
                this.time.delayedCall(2000, () => {
                    confirmText.destroy();
                    this.physics.resume();
                });
            }
            
            update() {
                this.player.setVelocity(0);
                
                let moving = false;
                
                if (this.cursors.left.isDown) {
                    this.player.setVelocityX(-this.speed);
                    this.player.anims.play('walk-left', true);
                    moving = true;
                } else if (this.cursors.right.isDown) {
                    this.player.setVelocityX(this.speed);
                    this.player.anims.play('walk-right', true);
                    moving = true;
                }
                
                if (this.cursors.up.isDown) {
                    this.player.setVelocityY(-this.speed);
                    this.player.anims.play('walk-up', true);
                    moving = true;
                } else if (this.cursors.down.isDown) {
                    this.player.setVelocityY(this.speed);
                    this.player.anims.play('walk-down', true);
                    moving = true;
                }
                
                if (!moving) {
                    this.player.anims.play('idle', true);
                }
                
                if (Phaser.Input.Keyboard.JustDown(this.interactKey)) {
                    this.handleInteraction();
                }
                
                if (Phaser.Input.Keyboard.JustDown(this.inventoryKey)) {
                    this.openInventory();
                }
            }
            
            handleInteraction() {
                if (gameState.currentMap === 'outside') {
                    const distance = Phaser.Math.Distance.Between(
                        this.player.x, this.player.y,
                        this.doorZone.x, this.doorZone.y
                    );
                    
                    if (distance < 50) {
                        this.enterHouse();
                    }
                } else if (gameState.currentMap === 'inside') {
                    const distance = Phaser.Math.Distance.Between(
                        this.player.x, this.player.y,
                        this.exitZone.x, this.exitZone.y
                    );
                    
                    if (distance < 50) {
                        this.exitHouse();
                    }
                }
            }
            
            enterHouse() {
                this.cameras.main.fade(250, 0, 0, 0);
                
                this.time.delayedCall(250, () => {
                    this.createInsideMap();
                    this.player.setPosition(400, 500);
                    this.cameras.main.fadeIn(250);
                });
            }
            
            exitHouse() {
                this.cameras.main.fade(250, 0, 0, 0);
                
                this.time.delayedCall(250, () => {
                    this.createOutsideMap();
                    this.player.setPosition(400, 280);
                    this.cameras.main.fadeIn(250);
                });
            }
            
            openInventory() {
                if (gameState.pokemon.length === 0) {
                    const noPokeText = this.add.text(400, 300, 'Tu n\'as pas encore de Pokémon !', {
                        fontSize: '20px',
                        fill: '#fff',
                        backgroundColor: '#e74c3c',
                        padding: { x: 15, y: 10 }
                    }).setOrigin(0.5);
                    noPokeText.setScrollFactor(0);
                    noPokeText.setDepth(500);
                    
                    this.time.delayedCall(1500, () => noPokeText.destroy());
                    return;
                }
                
                this.scene.pause();
                this.scene.launch('UIScene');
            }
        }

        // ============= CONFIGURATION PHASER =============
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            pixelArt: true,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: [GameScene, UIScene]
        };

        const game = new Phaser.Game(config);
    </script>
</body>
</html>                
